<!DOCTYPE html>
<html>
  <head> 
    <meta charset = "UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title> Decrept a secret Message</title>
    <link rel= "stylesheet" type = "text/css" href = "backendmain.css">
</head>
<body>
  <div class = "container">
    <div class = "box-1">
        <h1>Unverschl√ºsselte Daten: </h1>

        <h3>QR Scanner</h3>
        <div id="qr-reader" style="width:500px"></div>
        <div id="qr-reader-results"></div>
    </div>
  </div>

</body>


<script src="html5-qrcode.min.js"></script>

<script>

datafeld = document.getElementById('data')


function get_data(url, id){
return fetch(url+'/'+id, {
  "method": "GET",
  "headers": {}
})
.then(response => {
  return response.json()
})
//ToDo: Return Codes / Fehlerverarbeitung
}


//ToDo: Fehlerverarbeitung bei Fehlerhaften QR-Codes/ Keys
function importAESKey( key){
    return window.crypto.subtle.importKey(
        "raw",
        key,
        "AES-GCM",
        true,
        ["decrypt"]
    )
}

function decryptAEScipher( key, cipher, iv) {
    return window.crypto.subtle.decrypt(
        {
            name: "AES-GCM",
             iv: iv
        },
        key,
        cipher
    ).then( (encodedMSG) => {
        let dec = new TextDecoder();
        return dec.decode(encodedMSG)
    })

}
//ToDo: Fehlerverarbeitung von Fehlern bei Scans uws..
function onScanSuccess(decodedText, decodedResult) {
  if (decodedText !== lastResult) {
      ++countResults;
      lastResult = decodedText;
      console.log(decodedText)
      
      let id = decodedText.split(';')[1]
      let keyarray = decodedText.split(';')[0].split(',').map( x => parseInt(x))

 


    let importedkey;
    importAESKey(new Uint8Array(keyarray)
  ).then(k =>importedkey = k).then( () => {
      return get_data("http://localhost:5000/GET",id)}
  ).then(data =>{


      let iv = new Uint8Array(Object.values(data['IV']));
      let ciphertext = new Uint8Array(data['Message'].split(',').map( x => parseInt(x)))
      
      //console.log(ciphertext)
      return decryptAEScipher(importedkey , ciphertext, iv)
  }).then((msg) => {
    datafeld.textContent = msg
  })}}



//QR Scanner
var resultContainer = document.getElementById('qr-reader-results');
var lastResult, countResults = 0;      
var html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
html5QrcodeScanner.render(onScanSuccess);       


</script>
</body>
</html>
